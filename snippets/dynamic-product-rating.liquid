{% comment %}
  Snippet name: dynamic-product-rating
  Description: Works with multiple review systems
{% endcomment %}

{%- liquid
  # Try different review systems in order of priority
  assign rating = 0
  assign rating_count = 0
  assign rating_max = 5
  
  # 1. Check for Shopify's native reviews (if enabled)
  if product.metafields.reviews.rating.value != blank
    assign rating = product.metafields.reviews.rating.value.rating | times: 1.0
    assign rating_max = product.metafields.reviews.rating.value.scale_max | default: 5
    assign rating_count = product.metafields.reviews.rating_count | default: 0
  
  # 2. Check for Judge.me reviews
  elsif product.metafields.judgeme.badge != blank
    assign rating = product.metafields.judgeme.badge | split: "ratingValue" | last | split: '"' | first | split: ':' | last | times: 1.0
    assign rating_count = product.metafields.judgeme.badge | split: "reviewCount" | last | split: '"' | first | split: ':' | last | times: 1
  
  # 3. Check for Loox reviews
  elsif product.metafields.loox.avg_rating != blank
    assign rating = product.metafields.loox.avg_rating | times: 1.0
    assign rating_count = product.metafields.loox.num_reviews | default: 0
  
  # 4. Check for Yotpo reviews
  elsif product.metafields.yotpo.reviews_count != blank and product.metafields.yotpo.reviews_count > 0
    assign rating = product.metafields.yotpo.reviews_average | times: 1.0
    assign rating_count = product.metafields.yotpo.reviews_count
  
  # 5. Check for Stamped.io reviews
  elsif product.metafields.stamped.reviews != blank
    assign rating = product.metafields.stamped.reviews.rating_average | times: 1.0
    assign rating_count = product.metafields.stamped.reviews.reviews_count | default: 0
  
  # 6. Check for Product Reviews app (Shopify)
  elsif product.metafields.spr.reviews != blank
    assign rating = product.metafields.spr.reviews | split: 'ratingValue" content="' | last | split: '"' | first | times: 1.0
    assign rating_count = product.metafields.spr.reviews | split: 'reviewCount" content="' | last | split: '"' | first | times: 1
  endif
  
  # Normalize rating to 5-star scale if needed
  if rating_max != 5
    assign rating = rating | divided_by: rating_max | times: 5.0
  endif
  
  # Calculate percentage for star display
  assign rating_percentage = rating | divided_by: 5.0 | times: 100
-%}

{%- if rating > 0 -%}
  <div class="product-rating" aria-label="Rated {{ rating }} out of 5 stars">
    <div class="rating-stars">
      <div class="stars-active" style="width: {{ rating_percentage }}%"></div>
    </div>
    {%- if rating_count > 0 -%}
      <span class="rating-count">({{ rating_count }})</span>
    {%- endif -%}
  </div>
{%- endif -%}