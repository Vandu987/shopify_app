{% assign rating = product.metafields.custom.rating.value | default: 0.0 %}
{% assign rating_count = product.metafields.custom.rating_count.value | default: 0 %}

{% assign full_stars = rating | floor %}
{% assign half_star = 0 %}
{% if rating >= full_stars and rating < full_stars | plus: 1 %}
  {% assign decimal_part = rating | minus: full_stars %}
  {% if decimal_part >= 0.25 and decimal_part < 0.75 %}
    {% assign half_star = 1 %}
  {% elsif decimal_part >= 0.75 %}
    {% assign full_stars = full_stars | plus: 1 %}
  {% endif %}
{% endif %}
{% assign empty_stars = 5 | minus: full_stars | minus: half_star %}

<div class="product-rating-wrapper" itemscope itemtype="https://schema.org/Product">
  <div class="stars" itemprop="aggregateRating" itemscope itemtype="https://schema.org/AggregateRating">
    <meta itemprop="ratingValue" content="{{ rating }}">
    <meta itemprop="reviewCount" content="{{ rating_count }}">

    {%- for i in (1..full_stars) -%}
      <svg width="20" height="20" fill="#FFD700" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.431 8.332 1.151-6.064 5.885 1.472 8.292L12 18.896l-7.408 4.45 1.472-8.292L0 9.169l8.332-1.151z"/></svg>
    {%- endfor -%}

    {% if half_star == 1 %}
      <svg width="20" height="20" viewBox="0 0 24 24">
        <defs>
          <linearGradient id="half-grad" x1="0" y1="0" x2="100%" y2="0">
            <stop offset="50%" stop-color="#FFD700"/>
            <stop offset="50%" stop-color="#ccc"/>
          </linearGradient>
        </defs>
        <path fill="url(#half-grad)" d="M12 .587l3.668 7.431 8.332 1.151-6.064 5.885 1.472 8.292L12 18.896l-7.408 4.45 1.472-8.292L0 9.169l8.332-1.151z"/>
      </svg>
    {% endif %}

    {%- for i in (1..empty_stars) -%}
      <svg width="20" height="20" fill="#ccc" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.431 8.332 1.151-6.064 5.885 1.472 8.292L12 18.896l-7.408 4.45 1.472-8.292L0 9.169l8.332-1.151z"/></svg>
    {%- endfor -%}
  </div>

  {% if rating_count > 0 %}
    <span class="rating-count">({{ rating_count }})</span>
  {% endif %}
</div>
